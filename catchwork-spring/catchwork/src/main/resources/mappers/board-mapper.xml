<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.board.model.mapper.BoardMapper">

  <select id="selectBoardsByLatest" resultType="Board">
    SELECT 
      B.BOARD_NO,
      B.BOARD_TITLE,
      B.BOARD_CONTENT,
      TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_WRITE_DATE,
      TO_CHAR(B.BOARD_EDIT_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_EDIT_DATE,
      B.BOARD_READ_COUNT,
      B.BOARD_STATUS_CODE,
      B.BOARD_STATUS_DATE,
      B.BOARD_THUMBNAIL_URL,
      M.MEM_NO,
      M.MEM_NICKNAME,
      M.MEM_PROFILE_PATH
    FROM BOARD B
    JOIN MEMBER M ON B.MEM_NO = M.MEM_NO
    WHERE B.BOARD_STATUS_CODE = 0
    <if test="query != null and query != ''">
      AND (B.BOARD_TITLE LIKE '%' || #{query} || '%'
        OR B.BOARD_CONTENT LIKE '%' || #{query} || '%')
    </if>
    ORDER BY B.BOARD_WRITE_DATE DESC
  </select>

  <select id="selectBoardsByOldest" resultType="Board">
    SELECT 
      B.BOARD_NO,
      B.BOARD_TITLE,
      B.BOARD_CONTENT,
      TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_WRITE_DATE,
      TO_CHAR(B.BOARD_EDIT_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_EDIT_DATE,
      B.BOARD_READ_COUNT,
      B.BOARD_STATUS_CODE,
      B.BOARD_STATUS_DATE,
      B.BOARD_THUMBNAIL_URL,
      M.MEM_NO,
      M.MEM_NICKNAME,
      M.MEM_PROFILE_PATH
    FROM BOARD B
    JOIN MEMBER M ON B.MEM_NO = M.MEM_NO
    WHERE B.BOARD_STATUS_CODE = 0
    <if test="query != null and query != ''">
      AND (B.BOARD_TITLE LIKE '%' || #{query} || '%'
        OR B.BOARD_CONTENT LIKE '%' || #{query} || '%')
    </if>
    ORDER BY B.BOARD_WRITE_DATE ASC
  </select>

  <select id="selectBoardsByLikes" resultType="Board">
    SELECT 
      B.BOARD_NO,
      B.BOARD_TITLE,
      B.BOARD_CONTENT,
      TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_WRITE_DATE,
      TO_CHAR(B.BOARD_EDIT_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_EDIT_DATE,
      B.BOARD_READ_COUNT,
      B.BOARD_STATUS_CODE,
      B.BOARD_STATUS_DATE,
      B.BOARD_THUMBNAIL_URL,
      M.MEM_NO,
      M.MEM_NICKNAME,
      M.MEM_PROFILE_PATH,
      COUNT(L.LIKE_NO) AS LIKE_COUNT
    FROM BOARD B
    JOIN MEMBER M ON B.MEM_NO = M.MEM_NO
    LEFT JOIN BOARD_LIKE L ON B.BOARD_NO = L.BOARD_NO
    WHERE B.BOARD_STATUS_CODE = 0
    <if test="query != null and query != ''">
      AND (B.BOARD_TITLE LIKE '%' || #{query} || '%'
        OR B.BOARD_CONTENT LIKE '%' || #{query} || '%')
    </if>
    GROUP BY 
      B.BOARD_NO, B.BOARD_TITLE, B.BOARD_CONTENT, B.BOARD_WRITE_DATE, B.BOARD_EDIT_DATE,
      B.BOARD_READ_COUNT, B.BOARD_STATUS_CODE, B.BOARD_STATUS_DATE, B.BOARD_THUMBNAIL_URL,
      M.MEM_NO, M.MEM_NICKNAME, M.MEM_PROFILE_PATH
    ORDER BY LIKE_COUNT DESC
  </select>

  <select id="selectBoardsByComments" resultType="Board">
    SELECT 
      B.BOARD_NO,
      B.BOARD_TITLE,
      B.BOARD_CONTENT,
      TO_CHAR(B.BOARD_WRITE_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_WRITE_DATE,
      TO_CHAR(B.BOARD_EDIT_DATE, 'YYYY-MM-DD HH24:MI:SS') AS BOARD_EDIT_DATE,
      B.BOARD_READ_COUNT,
      B.BOARD_STATUS_CODE,
      B.BOARD_STATUS_DATE,
      B.BOARD_THUMBNAIL_URL,
      M.MEM_NO,
      M.MEM_NICKNAME,
      M.MEM_PROFILE_PATH,
      (SELECT COUNT(*) FROM COMMENT C WHERE C.BOARD_NO = B.BOARD_NO) AS COMMENT_COUNT,
      (SELECT COUNT(*) FROM BOARD_LIKE L WHERE L.BOARD_NO = B.BOARD_NO) AS LIKE_COUNT
    FROM BOARD B
    JOIN MEMBER M ON B.MEM_NO = M.MEM_NO
    LEFT JOIN COMMENT C ON B.BOARD_NO = C.BOARD_NO
    WHERE B.BOARD_STATUS_CODE = 0
    <if test="query != null and query != ''">
      AND (B.BOARD_TITLE LIKE '%' || #{query} || '%'
        OR B.BOARD_CONTENT LIKE '%' || #{query} || '%')
    </if>
    GROUP BY 
      B.BOARD_NO, B.BOARD_TITLE, B.BOARD_CONTENT, B.BOARD_WRITE_DATE, B.BOARD_EDIT_DATE,
      B.BOARD_READ_COUNT, B.BOARD_STATUS_CODE, B.BOARD_STATUS_DATE, B.BOARD_THUMBNAIL_URL,
      M.MEM_NO, M.MEM_NICKNAME, M.MEM_PROFILE_PATH
    ORDER BY COMMENT_COUNT DESC
  </select>

</mapper>
